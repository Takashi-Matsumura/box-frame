// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  GUEST
  USER
  MANAGER
  EXECUTIVE
  ADMIN
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String        @id @default(cuid())
  name          String?
  email         String?       @unique
  emailVerified DateTime?
  image         String?
  role          Role          @default(USER)
  language      String        @default("ja")
  timezone      String        @default("Asia/Tokyo")
  braveApiKey   String?
  systemPrompt  String?
  lastSignInAt  DateTime?
  twoFactorEnabled Boolean    @default(false)
  twoFactorSecret  String?
  accounts      Account[]
  sessions      Session[]
  userAccessKeys UserAccessKey[]
  targetedAccessKeys AccessKey[]
  ldapMappings  LdapUserMapping[]
  notifications Notification[]
  auditLogs     AuditLog[]
  announcements Announcement[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ========================================
// LDAP認証システム関連モデル
// ========================================

model LdapConfig {
  id            String   @id @default(cuid())
  isEnabled     Boolean  @default(false)
  serverUrl     String   @default("")
  baseDN        String   @default("")
  bindDN        String?
  bindPassword  String?
  searchFilter  String   @default("(uid={username})")
  timeout       Int      @default(10000)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  updatedBy     String?
}

model LdapUserMapping {
  id               String   @id @default(cuid())
  ldapUsername     String   @unique
  userId           String   @unique
  ldapDN           String?
  email            String?
  displayName      String?
  mappingType      LdapMappingType @default(MANUAL)
  isActive         Boolean  @default(true)
  lastLoginAt      DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  createdBy        String?
  migrated         Boolean  @default(false)
  migratedAt       DateTime?
  migratedFrom     String?
  mustChangePassword Boolean @default(false)

  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([ldapUsername])
  @@index([userId])
  @@index([migrated])
}

enum LdapMappingType {
  AUTO
  MANUAL
}

// ========================================
// 通知システム
// ========================================

enum NotificationType {
  SYSTEM    // システム通知（メンテナンス等）
  SECURITY  // セキュリティ（ログイン検出等）
  ACTION    // アクション要求（承認依頼等）
  INFO      // 一般情報
  WARNING   // 警告
  ERROR     // エラー
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model LdapAuthLog {
  id            String   @id @default(cuid())
  ldapUsername  String
  success       Boolean
  failureReason String?
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime @default(now())

  @@index([ldapUsername])
  @@index([createdAt])
  @@index([success])
}

model OpenLdapConfig {
  id            String   @id @default(cuid())
  isEnabled     Boolean  @default(true)
  serverUrl     String   @default("")
  adminDN       String   @default("")
  adminPassword String   @default("")
  baseDN        String   @default("")
  usersOU       String   @default("")
  timeout       Int      @default(10000)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ========================================
// アクセス制御システム
// ========================================

model Permission {
  id                    String                  @id @default(cuid())
  name                  String                  @unique
  displayName           String
  description           String?
  menuPath              String
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  accessKeyPermissions  AccessKeyPermission[]
}

model AccessKey {
  id              String                @id @default(cuid())
  key             String                @unique
  name            String
  targetUserId    String?
  targetUser      User?                 @relation(fields: [targetUserId], references: [id], onDelete: Cascade)
  menuPaths       String
  expiresAt       DateTime
  isActive        Boolean               @default(true)
  createdBy       String
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  permissions     AccessKeyPermission[]
  userAccessKeys  UserAccessKey[]
}

model AccessKeyPermission {
  id           String     @id @default(cuid())
  accessKeyId  String
  permissionId String
  accessKey    AccessKey  @relation(fields: [accessKeyId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())

  @@unique([accessKeyId, permissionId])
}

model UserAccessKey {
  id          String    @id @default(cuid())
  userId      String
  accessKeyId String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessKey   AccessKey @relation(fields: [accessKeyId], references: [id], onDelete: Cascade)
  activatedAt DateTime  @default(now())

  @@unique([userId, accessKeyId])
}

// ========================================
// システム設定
// ========================================

model SystemSetting {
  key       String   @id
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ========================================
// 通知モデル
// ========================================

model Notification {
  id            String               @id @default(cuid())
  userId        String
  user          User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  type          NotificationType     @default(INFO)
  priority      NotificationPriority @default(NORMAL)

  title         String
  titleJa       String?
  message       String
  messageJa     String?

  actionUrl     String?
  actionLabel   String?
  actionLabelJa String?

  source        String?
  sourceId      String?

  isRead        Boolean              @default(false)
  readAt        DateTime?
  metadata      Json?
  expiresAt     DateTime?

  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt

  @@index([userId])
  @@index([userId, isRead])
  @@index([createdAt])
}

// ========================================
// 監査ログ
// ========================================

model AuditLog {
  id          String   @id @default(cuid())
  action      String   // LOGIN_SUCCESS, LOGIN_FAILURE, USER_CREATE, USER_DELETE, etc.
  category    String   // AUTH, USER_MANAGEMENT, SYSTEM_SETTING, MODULE
  userId      String?  // 操作を行ったユーザー（ログイン失敗時はnull）
  targetId    String?  // 操作対象のID
  targetType  String?  // 操作対象の種類（User, SystemSetting等）
  details     String?  // JSON形式の詳細情報
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([action])
  @@index([category])
  @@index([userId])
  @@index([createdAt])
}

// ========================================
// システムアナウンス
// ========================================

model Announcement {
  id          String    @id @default(cuid())
  title       String
  titleJa     String?
  message     String
  messageJa   String?
  level       String    @default("info") // info, warning, critical
  isActive    Boolean   @default(true)
  startAt     DateTime  @default(now())
  endAt       DateTime?
  createdBy   String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  creator     User      @relation(fields: [createdBy], references: [id])

  @@index([isActive, startAt, endAt])
}

// ========================================
// 会社組織管理システム
// ========================================

enum OrganizationStatus {
  DRAFT      // 下書き（編集中）
  SCHEDULED  // 公開予定（公開日待ち）
  PUBLISHED  // 公開中
  ARCHIVED   // アーカイブ済み
}

// 組織（会社）
model Organization {
  id                    String                @id @default(cuid())
  name                  String                @unique
  description           String?
  status                OrganizationStatus    @default(DRAFT)
  publishAt             DateTime?             // 公開予定日時
  publishedAt           DateTime?             // 実際に公開された日時
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  departments           Department[]
  employees             Employee[]
  employeeHistories     EmployeeHistory[]     @relation("OrganizationEmployeeHistories")
  organizationHistories OrganizationHistory[] @relation("OrganizationHistories")

  @@index([status, publishAt])
}

// 本部（Department）
model Department {
  id             String       @id @default(cuid())
  name           String
  code           String?
  description    String?
  organizationId String
  managerId      String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  manager        Employee?    @relation("DepartmentManager", fields: [managerId], references: [id])
  employees      Employee[]   @relation("DepartmentEmployees")
  sections       Section[]

  @@unique([organizationId, name])
}

// 部（Section）
model Section {
  id           String     @id @default(cuid())
  name         String
  code         String?
  description  String?
  departmentId String
  managerId    String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  manager      Employee?  @relation("SectionManager", fields: [managerId], references: [id])
  employees    Employee[] @relation("SectionEmployees")
  courses      Course[]

  @@unique([departmentId, name])
}

// 課（Course）
model Course {
  id          String     @id @default(cuid())
  name        String
  code        String?
  description String?
  sectionId   String
  managerId   String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  section     Section    @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  manager     Employee?  @relation("CourseManager", fields: [managerId], references: [id])
  employees   Employee[] @relation("CourseEmployees")

  @@unique([sectionId, name])
}

// 社員
model Employee {
  id                 String            @id @default(cuid())
  employeeId         String            @unique
  name               String
  nameKana           String?
  email              String?           @unique
  profileImage       String?
  phone              String?
  position           String
  positionCode       String?
  qualificationGrade String?
  qualificationGradeCode String?
  employmentType     String?
  employmentTypeCode String?
  departmentCode     String?
  joinDate           DateTime?
  birthDate          DateTime?
  isActive           Boolean           @default(true)
  organizationId     String
  departmentId       String
  sectionId          String?
  courseId           String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  organization       Organization      @relation(fields: [organizationId], references: [id])
  department         Department        @relation("DepartmentEmployees", fields: [departmentId], references: [id])
  section            Section?          @relation("SectionEmployees", fields: [sectionId], references: [id])
  course             Course?           @relation("CourseEmployees", fields: [courseId], references: [id])
  managedDepartments Department[]      @relation("DepartmentManager")
  managedSections    Section[]         @relation("SectionManager")
  managedCourses     Course[]          @relation("CourseManager")
  histories          EmployeeHistory[] @relation("EmployeeHistories")

  // 人事評価モジュール関連
  evaluations        Evaluation[]      @relation("evaluations")
  evaluationsGiven   Evaluation[]      @relation("evaluationsGiven")
  evaluationGoals    EvaluationGoal[]
  customEvaluatees   CustomEvaluator[] @relation("customEvaluatee")
  customEvaluators   CustomEvaluator[] @relation("customEvaluator")
  exclusions         EvaluationExclusion[]
}

// ========================================
// 履歴管理システム
// ========================================

// 変更タイプ
enum ChangeType {
  CREATE
  UPDATE
  DELETE
  TRANSFER
  PROMOTION
  RETIREMENT
  REJOINING
  IMPORT
  BULK_UPDATE
  EXPORT
}

// 社員データ履歴（スナップショット方式）
model EmployeeHistory {
  id                 String       @id @default(cuid())
  employeeId         String
  validFrom          DateTime
  validTo            DateTime?
  name               String
  nameKana           String?
  email              String
  profileImage       String?
  phone              String?
  position           String
  positionCode       String?
  qualificationGrade String?
  qualificationGradeCode String?
  employmentType     String?
  employmentTypeCode String?
  departmentCode     String?
  joinDate           DateTime?
  birthDate          DateTime?
  isActive           Boolean      @default(true)
  organizationId     String
  departmentId       String
  departmentName     String
  sectionId          String?
  sectionName        String?
  courseId           String?
  courseName         String?
  changeType         ChangeType
  changeReason       String?
  changedBy          String
  changedAt          DateTime     @default(now())
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  employee           Employee     @relation("EmployeeHistories", fields: [employeeId], references: [id], onDelete: Cascade)
  organization       Organization @relation("OrganizationEmployeeHistories", fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([employeeId, validFrom])
  @@index([validFrom, validTo])
  @@index([changeType])
}

// 組織構造履歴（スナップショット方式）
model OrganizationHistory {
  id                    String       @id @default(cuid())
  organizationId        String
  validFrom             DateTime
  validTo               DateTime?
  structureSnapshot     String
  employeeCountSnapshot Int
  departmentCount       Int
  sectionCount          Int
  courseCount           Int
  changeType            ChangeType
  changeDescription     String?
  changedBy             String
  changedAt             DateTime     @default(now())
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  organization          Organization @relation("OrganizationHistories", fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, validFrom])
  @@index([validFrom, validTo])
  @@index([changeType])
}

// 変更ログ（詳細な変更追跡）
model ChangeLog {
  id                String     @id @default(cuid())
  entityType        String
  entityId          String
  changeType        ChangeType
  fieldName         String?
  oldValue          String?
  newValue          String?
  changeDescription String?
  changeReason      String?
  batchId           String?
  changedBy         String
  changedAt         DateTime   @default(now())
  ipAddress         String?
  userAgent         String?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  @@index([entityType, entityId])
  @@index([changeType])
  @@index([changedBy])
  @@index([changedAt])
  @@index([batchId])
}

// ========================================
// 人事評価システム
// ========================================

// 評価期間ステータス
enum EvaluationPeriodStatus {
  DRAFT       // 準備中
  ACTIVE      // 評価実施中
  REVIEW      // レビュー期間
  CLOSED      // 完了
}

// 評価ステータス
enum EvaluationStatus {
  PENDING     // 未評価
  IN_PROGRESS // 評価中
  COMPLETED   // 評価完了
  CONFIRMED   // 確定済み
}

// 評価期間
model EvaluationPeriod {
  id                String                 @id @default(cuid())
  name              String                 // "2024年度 上期評価"
  year              Int                    // 2024
  term              String                 // "H1" | "H2" | "ANNUAL"
  status            EvaluationPeriodStatus @default(DRAFT)

  // 期間
  startDate         DateTime
  endDate           DateTime

  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt

  evaluations       Evaluation[]
  goals             EvaluationGoal[]
  weights           EvaluationWeight[]
  organizationGoals OrganizationGoal[]
  customEvaluators  CustomEvaluator[]
  exclusions        EvaluationExclusion[]

  @@index([year, term])
  @@index([status])
}

// 重み設定（資格等級別）
model EvaluationWeight {
  id                String           @id @default(cuid())

  periodId          String
  period            EvaluationPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)

  gradeCode         String           // "G1", "G2", ... or "DEFAULT"

  // 重み（%、合計100）
  resultsWeight     Int              @default(30)   // 結果評価
  processWeight     Int              @default(40)   // プロセス評価
  growthWeight      Int              @default(30)   // 成長評価

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@unique([periodId, gradeCode])
}

// 組織目標・実績（結果評価用）
model OrganizationGoal {
  id                String           @id @default(cuid())

  periodId          String
  period            EvaluationPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)

  // 対象組織（Department/Section/Course のいずれか）
  organizationType  String           // "DEPARTMENT" | "SECTION" | "COURSE"
  organizationId    String
  organizationName  String

  // 目標・実績
  targetProfit      Float?           // 目標利益
  actualProfit      Float?           // 実績利益
  achievementRate   Float?           // 達成率（%）

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@unique([periodId, organizationType, organizationId])
  @@index([periodId])
}

// カスタム評価者関係
model CustomEvaluator {
  id                String            @id @default(cuid())

  employeeId        String
  employee          Employee          @relation("customEvaluatee", fields: [employeeId], references: [id], onDelete: Cascade)

  evaluatorId       String
  evaluator         Employee          @relation("customEvaluator", fields: [evaluatorId], references: [id], onDelete: Cascade)

  periodId          String?           // null = 全期間有効
  period            EvaluationPeriod? @relation(fields: [periodId], references: [id], onDelete: Cascade)

  // 有効期間（期間を限定する場合）
  effectiveFrom     DateTime?
  effectiveTo       DateTime?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@unique([employeeId, periodId])
  @@index([evaluatorId])
}

// 評価対象外理由
enum ExclusionReason {
  MATERNITY_LEAVE     // 育児休業
  SICK_LEAVE          // 病気休職
  RESIGNATION         // 退職予定
  SECONDMENT          // 出向中
  PROBATION           // 試用期間
  OTHER               // その他
}

// 評価対象外設定
model EvaluationExclusion {
  id                String            @id @default(cuid())

  employeeId        String
  employee          Employee          @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  periodId          String?           // null = 全期間対象外
  period            EvaluationPeriod? @relation(fields: [periodId], references: [id], onDelete: Cascade)

  reason            ExclusionReason   @default(OTHER)
  note              String?           // 補足説明

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@unique([employeeId, periodId])
  @@index([reason])
}

// プロセス評価項目マスタ
model ProcessCategory {
  id                String   @id @default(cuid())
  name              String   // "主体性"
  nameEn            String?  // "Initiative"
  description       String?  // 説明文
  sortOrder         Int      @default(0)
  isActive          Boolean  @default(true)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([isActive, sortOrder])
}

// 成長評価カテゴリマスタ
model GrowthCategory {
  id                String   @id @default(cuid())
  name              String   // "専門スキル向上"
  nameEn            String?  // "Professional Skill Improvement"
  description       String?  // 説明文
  coefficient       Float    @default(1.0)  // スコア係数
  sortOrder         Int      @default(0)
  isActive          Boolean  @default(true)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([isActive, sortOrder])
}

// 評価データ
model Evaluation {
  id                String           @id @default(cuid())

  // 関連
  periodId          String
  period            EvaluationPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)
  employeeId        String
  employee          Employee         @relation("evaluations", fields: [employeeId], references: [id])
  evaluatorId       String?
  evaluator         Employee?        @relation("evaluationsGiven", fields: [evaluatorId], references: [id])

  // スナップショット（評価時点の情報）
  departmentName    String?
  sectionName       String?
  courseName        String?
  positionName      String?
  gradeCode         String?          // 資格等級コード

  // ========== 基準1: 結果評価 ==========
  score1            Float?           // 結果評価スコア（自動計算）
  score1Comment     String?

  // ========== 基準2: プロセス評価 ==========
  // JSON: {"主体性": 3, "協調性": 4, ...}
  processScores     Json?
  score2            Float?           // プロセス評価スコア（平均）
  score2Comment     String?

  // ========== 基準3: 成長評価 ==========
  growthCategoryId  String?          // 選択した成長カテゴリ
  growthLevel       Int?             // T1=1, T2=2, T3=3, T4=4
  score3            Float?           // 成長評価スコア（レベル × 係数）
  score3Comment     String?

  // ========== 最終評価 ==========
  // 加重スコア（保存用）
  weightedScore1    Float?
  weightedScore2    Float?
  weightedScore3    Float?

  finalScore        Float?           // 最終スコア
  finalGrade        String?          // S/A/B/C/D
  overallComment    String?          // 総合コメント

  // ステータス
  status            EvaluationStatus @default(PENDING)

  // メタ情報
  evaluatedAt       DateTime?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@unique([periodId, employeeId])
  @@index([periodId])
  @@index([employeeId])
  @@index([evaluatorId])
  @@index([status])
}

// 目標設定（オプション機能）
model EvaluationGoal {
  id                String           @id @default(cuid())

  periodId          String
  period            EvaluationPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)
  employeeId        String
  employee          Employee         @relation(fields: [employeeId], references: [id])

  // 目標（JSON配列）
  goals             Json             @default("[]")
  // 自己振り返り
  selfReflection    String?

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@unique([periodId, employeeId])
}
